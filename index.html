<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Network IDS/IDP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27; color: #e0e0e0; line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px; border-radius: 10px; margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 { font-size: 2em; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; margin-bottom: 10px; }
        .status { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .status-card {
            background: rgba(255,255,255,0.1); padding: 15px 25px;
            border-radius: 8px; backdrop-filter: blur(10px);
        }
        .status-value { font-size: 1.8em; font-weight: bold; color: #4CAF50; }
        .status-label { font-size: 0.9em; opacity: 0.8; }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .card {
            background: #1a1f3a; border-radius: 10px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #2a3f5f;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #2a3f5f;
        }
        .card-title { font-size: 1.3em; font-weight: 600; }
        .alert-item {
            background: #252d4a; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #ffa726;
        }
        .alert-critical { border-left-color: #f44336; background: #3d1f1f; }
        .alert-high { border-left-color: #ff5722; background: #3d2a1f; }
        .alert-medium { border-left-color: #ffa726; background: #3d331f; }
        .alert-low { border-left-color: #4CAF50; background: #1f3d2a; }
        .severity-badge {
            padding: 3px 10px; border-radius: 12px;
            font-size: 0.85em; font-weight: 600;
        }
        .badge-critical { background: #f44336; color: white; }
        .badge-high { background: #ff5722; color: white; }
        .badge-medium { background: #ffa726; color: #000; }
        .badge-low { background: #4CAF50; color: white; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.95em; font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-small { padding: 5px 12px; font-size: 0.85em; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .input-group { display: flex; gap: 10px; flex: 1; min-width: 250px; }
        input {
            flex: 1; padding: 10px; border: 1px solid #2a3f5f;
            border-radius: 6px; background: #1a1f3a; color: #e0e0e0;
        }
        .scrollable { max-height: 500px; overflow-y: auto; }
        .empty-state { text-align: center; padding: 40px; color: #666; }
        .connection-status {
            display: inline-block; width: 12px; height: 12px;
            border-radius: 50%; margin-right: 8px;
        }
        .status-connected { background: #4CAF50; box-shadow: 0 0 10px #4CAF50; }
        .status-disconnected { background: #f44336; }
        .info-banner {
            background: #2a3f5f; padding: 15px; border-radius: 8px;
            margin-bottom: 20px; border-left: 4px solid #2196F3;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Home Network IDS/IDP</h1>
            <p class="subtitle">Real-time Network Security with AI Analysis</p>
            <div class="info-banner">
                <strong>Simplified Mode:</strong> Using built-in network monitoring (No Suricata required)
            </div>
            <div class="status">
                <div class="status-card">
                    <div class="status-value" id="status-value">‚óè</div>
                    <div class="status-label">System Status</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="alerts-count">0</div>
                    <div class="status-label">Total Alerts</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="blocked-count">0</div>
                    <div class="status-label">Blocked IPs</div>
                </div>
                <div class="status-card">
                    <div class="status-value">
                        <span class="connection-status" id="ws-status"></span>
                        <span id="ws-text">Connecting...</span>
                    </div>
                    <div class="status-label">WebSocket</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="generateTestAlert()">üß™ Test Alert</button>
            <div class="input-group">
                <input type="text" id="ip-input" placeholder="Enter IP to block (e.g., 192.168.1.50)">
                <button class="btn btn-danger" onclick="blockIP()">üö´ Block IP</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üö® Recent Alerts</h2>
                    <button class="btn btn-small btn-primary" onclick="loadAlerts()">Refresh</button>
                </div>
                <div class="scrollable" id="alerts-container">
                    <div class="empty-state">Waiting for alerts...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üö´ Blocked IPs</h2>
                    <button class="btn btn-small btn-primary" onclick="loadBlockedIPs()">Refresh</button>
                </div>
                <div class="scrollable" id="blocked-ips-container">
                    <div class="empty-state">No blocked IPs</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://' + window.location.hostname + ':8000';
        const WS = 'ws://' + window.location.hostname + ':8000/ws';
        let ws = null;

        function initWebSocket() {
            ws = new WebSocket(WS);
            ws.onopen = () => {
                document.getElementById('ws-status').className = 'connection-status status-connected';
                document.getElementById('ws-text').textContent = 'Connected';
            };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'ip_blocked') {
                    loadBlockedIPs();
                } else {
                    addAlertToUI(data);
                    updateStats();
                }
            };
            ws.onclose = () => {
                document.getElementById('ws-status').className = 'connection-status status-disconnected';
                document.getElementById('ws-text').textContent = 'Disconnected';
                setTimeout(initWebSocket, 5000);
            };
        }

        function addAlertToUI(alert) {
            const container = document.getElementById('alerts-container');
            if (container.querySelector('.empty-state')) container.innerHTML = '';

            const sev = (alert.analysis?.severity || 'Unknown').toLowerCase();
            const el = document.createElement('div');
            el.className = `alert-item alert-${sev}`;
            el.innerHTML = `
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <strong>${alert.alert?.signature || 'Alert'}</strong>
                    <span class="severity-badge badge-${sev}">${alert.analysis?.severity || 'Unknown'}</span>
                </div>
                <div style="font-size:0.9em;color:#b0b0b0;">
                    <div>üåê ${alert.src_ip}:${alert.src_port} ‚Üí ${alert.dest_ip}:${alert.dest_port}</div>
                    <div>‚è∞ ${new Date(alert.timestamp).toLocaleString()}</div>
                    ${alert.alert?.risk_factors ? `<div>‚ö†Ô∏è ${alert.alert.risk_factors.join(', ')}</div>` : ''}
                </div>
                ${alert.analysis ? `<div style="margin-top:10px;padding:10px;background:rgba(0,0,0,0.3);border-radius:5px;font-size:0.9em;">
                    <div><strong>Analysis:</strong> ${alert.analysis.explanation}</div>
                    <div><strong>Action:</strong> ${alert.analysis.action}</div>
                    ${alert.auto_blocked ? '<div style="color:#ff5722;margin-top:5px;"><strong>üîí Auto-blocked</strong></div>' : ''}
                </div>` : ''}
            `;
            container.insertBefore(el, container.firstChild);
            while (container.children.length > 50) container.removeChild(container.lastChild);
        }

        async function loadAlerts() {
            try {
                const res = await fetch(`${API}/api/alerts?limit=50`);
                const data = await res.json();
                const container = document.getElementById('alerts-container');
                container.innerHTML = data.alerts.length === 0 ? '<div class="empty-state">No alerts yet</div>' : '';
                data.alerts.reverse().forEach(addAlertToUI);
            } catch (e) {
                console.error('Failed to load alerts:', e);
            }
        }

        async function loadBlockedIPs() {
            try {
                const res = await fetch(`${API}/api/blocked`);
                const data = await res.json();
                const container = document.getElementById('blocked-ips-container');
                container.innerHTML = data.blocked_ips.length === 0 ? '<div class="empty-state">No blocked IPs</div>' : '';
                data.blocked_ips.forEach(ip => {
                    const el = document.createElement('div');
                    el.style.cssText = 'display:flex;justify-content:space-between;padding:10px;background:#252d4a;margin-bottom:8px;border-radius:6px;';
                    el.innerHTML = `<span>üö´ ${ip}</span><button class="btn btn-small btn-primary" onclick="unblockIP('${ip}')">Unblock</button>`;
                    container.appendChild(el);
                });
            } catch (e) {
                console.error('Failed to load blocked IPs:', e);
            }
        }

        async function updateStats() {
            try {
                const res = await fetch(`${API}/api/status`);
                const data = await res.json();
                document.getElementById('status-value').textContent = data.status === 'running' ? '‚úì' : '‚úó';
                document.getElementById('status-value').style.color = data.status === 'running' ? '#4CAF50' : '#f44336';
                document.getElementById('alerts-count').textContent = data.alerts_count;
                document.getElementById('blocked-count').textContent = data.blocked_ips_count;
            } catch (e) {
                console.error('Failed to update stats:', e);
            }
        }

        async function blockIP() {
            const ip = document.getElementById('ip-input').value.trim();
            if (!ip) return alert('Enter an IP address');
            try {
                const res = await fetch(`${API}/api/block/${ip}`, {method: 'POST'});
                const data = await res.json();
                alert(data.success ? `Blocked ${ip}` : `Error: ${data.error}`);
                if (data.success) {
                    document.getElementById('ip-input').value = '';
                    loadBlockedIPs();
                    updateStats();
                }
            } catch (e) {
                alert('Failed to block IP: ' + e.message);
            }
        }

        async function unblockIP(ip) {
            try {
                const res = await fetch(`${API}/api/unblock/${ip}`, {method: 'POST'});
                const data = await res.json();
                alert(data.success ? `Unblocked ${ip}` : `Error: ${data.error}`);
                if (data.success) { loadBlockedIPs(); updateStats(); }
            } catch (e) {
                alert('Failed to unblock IP: ' + e.message);
            }
        }

        async function generateTestAlert() {
            try {
                const res = await fetch(`${API}/api/status`);
                alert('Test alerts will appear automatically every 30 seconds. Watch for new alerts!');
            } catch (e) {
                alert('System not responding');
            }
        }

        function refreshData() {
            loadAlerts();
            loadBlockedIPs();
            updateStats();
        }

        initWebSocket();
        updateStats();
        loadAlerts();
        loadBlockedIPs();
        setInterval(updateStats, 30000);
    </script>
</body>
</html>
